#!/bin/bash
# Helper script for CLI interaction

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
BRANCH=$(git -C "$SCRIPT_DIR" rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
SESSION="aidna-${BRANCH}"
DELAY=0.3

# Ensure session exists with CLI running
ensure_session() {
    if ! tmux has-session -t "$SESSION" 2>/dev/null; then
        tmux new-session -d -s "$SESSION" -c "$SCRIPT_DIR" "$SCRIPT_DIR/cli.sh"
        sleep 0.5
    fi
}

ensure_session

# Clear scrollback before any action
tmux clear-history -t "$SESSION"

if [ $# -eq 0 ]; then
    # No args: just capture with full scrollback
    tmux capture-pane -t "$SESSION" -p -S -
else
    keys="$1"

    # Split by comma and execute each key
    IFS=',' read -ra KEY_ARRAY <<< "$keys"
    for key in "${KEY_ARRAY[@]}"; do
        tmux send-keys -t "$SESSION" "$key"
        sleep "$DELAY"
    done
    sleep 3.0  # Wait for any processing to at least start

    # Capture with full scrollback
    tmux capture-pane -t "$SESSION" -p -S -
fi
