#!/bin/bash
# Helper script for CLI interaction

SESSION="CONTROL"
DEFAULT_DELAY=0.3
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Ensure session exists with CLI running
ensure_session() {
    if ! tmux has-session -t "$SESSION" 2>/dev/null; then
        tmux new-session -d -s "$SESSION" -c "$SCRIPT_DIR" "$SCRIPT_DIR/cli.sh"
        sleep 0.5
    fi
}

ensure_session

# Clear scrollback before any action
tmux clear-history -t "$SESSION"

if [ $# -eq 0 ]; then
    # No args: just capture with full scrollback
    tmux capture-pane -t "$SESSION" -p -S -
else
    keys="$1"
    delay="${2:-$DEFAULT_DELAY}"

    # Split by comma and execute each key
    IFS=',' read -ra KEY_ARRAY <<< "$keys"
    for key in "${KEY_ARRAY[@]}"; do
        tmux send-keys -t "$SESSION" "$key"
        sleep "$delay"
    done

    # Capture with full scrollback
    tmux capture-pane -t "$SESSION" -p -S -
fi
